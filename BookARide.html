<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book a Ride - RideFusion</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .particle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: linear-gradient(45deg, #fbbf24, #f59e0b);
      border-radius: 50%;
      animation: float 15s infinite linear;
      opacity: 1;
      box-shadow: 0 0 12px #fbbf24;
    }
    @keyframes float {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }
    .ride-card {
      transition: all 0.3s ease;
    }
    .ride-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(251, 191, 36, 0.3);
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-black text-white min-h-screen relative">

  <!-- Floating Particles -->
  <div class="fixed inset-0 pointer-events-none z-0">
    <div class="particle" style="left:10%;animation-delay:0s;"></div>
    <div class="particle" style="left:30%;animation-delay:2s;"></div>
    <div class="particle" style="left:50%;animation-delay:4s;"></div>
    <div class="particle" style="left:70%;animation-delay:6s;"></div>
    <div class="particle" style="left:90%;animation-delay:8s;"></div>
  </div>

  <!-- Background Image -->
  <div class="fixed inset-0 z-0">
    <img src="https://images.unsplash.com/photo-1449824913935-59a10b8d2000?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80" class="w-full h-full object-cover opacity-40">
    <div class="absolute inset-0 bg-gradient-to-br from-black/80 via-black/70 to-black/80"></div>
  </div>

  <!-- Navigation Bar -->
  <nav class="bg-black/80 backdrop-blur-sm border-b border-yellow-600/30 sticky top-0 z-50 relative">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-lg flex items-center justify-center shadow-lg">
            <span class="text-black font-bold text-xl">R</span>
          </div>
          <div>
            <span class="text-2xl font-bold bg-gradient-to-r from-yellow-400 to-yellow-600 bg-clip-text text-transparent">RideFusion</span>
            <div class="text-xs text-yellow-400">Rajpura Local Transport</div>
          </div>
        </div>
        <div class="hidden md:flex items-center space-x-6">
          <a href="finalhomepage.html" class="text-gray-300 hover:text-yellow-400 transition">Home</a>
          <a href="finalbookride.html" class="text-yellow-400 font-semibold">Find Rides</a>
          <a href="finalofferaride.html" class="text-gray-300 hover:text-yellow-400 transition">Offer Rides</a>
          <span id="userInfo" class="text-gray-300"></span>
          <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm">
            Logout
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="relative z-10 max-w-7xl mx-auto px-6 py-8">
    
    <!-- Welcome Message -->
    <div class="bg-black/60 backdrop-blur-xl rounded-2xl p-6 mb-6 border border-yellow-600/30">
      <h1 class="text-3xl font-bold text-yellow-400 mb-2">Find Your Perfect Ride ğŸš—</h1>
      <p class="text-gray-300" id="welcomeMessage">Loading user info...</p>
    </div>

    <!-- Search Filters -->
    <div class="bg-black/60 backdrop-blur-xl rounded-2xl p-6 mb-6 border border-yellow-600/30">
      <h3 class="text-xl font-bold text-yellow-400 mb-4">ğŸ” Search & Filter Rides</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <select id="filterVehicle" class="bg-gray-900 border border-yellow-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
          <option value="">All Vehicles</option>
          <option value="Car">ğŸš— Car</option>
          <option value="Auto">ğŸ›º Auto Rickshaw</option>
          <option value="Bike">ğŸï¸ Bike</option>
        </select>
        
        <input type="date" id="filterDate" class="bg-gray-900 border border-yellow-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
        
        <input type="text" id="searchLocation" placeholder="ğŸ” Search location..." class="bg-gray-900 border border-yellow-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
        
        <button id="searchBtn" class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-black font-bold rounded-lg px-6 py-3 hover:shadow-lg transition transform hover:scale-105">
          Search Rides
        </button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-gradient-to-r from-green-600/20 to-green-500/20 backdrop-blur-xl rounded-xl p-4 border border-green-500/30">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-400 text-sm font-semibold">Available Rides</p>
            <p class="text-2xl font-bold text-white" id="totalRides">0</p>
          </div>
          <div class="text-3xl">ğŸš—</div>
        </div>
      </div>
      
      <div class="bg-gradient-to-r from-blue-600/20 to-blue-500/20 backdrop-blur-xl rounded-xl p-4 border border-blue-500/30">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-400 text-sm font-semibold">Total Seats</p>
            <p class="text-2xl font-bold text-white" id="totalSeats">0</p>
          </div>
          <div class="text-3xl">ğŸ’º</div>
        </div>
      </div>
      
      <div class="bg-gradient-to-r from-yellow-600/20 to-yellow-500/20 backdrop-blur-xl rounded-xl p-4 border border-yellow-500/30">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-yellow-400 text-sm font-semibold">Your Discount</p>
            <p class="text-2xl font-bold text-white" id="userDiscount">0%</p>
          </div>
          <div class="text-3xl">ğŸ“</div>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="hidden text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-yellow-500 border-t-transparent"></div>
      <p class="text-gray-400 mt-4">Loading available rides...</p>
    </div>

    <!-- Available Rides -->
    <h2 class="text-2xl font-bold text-yellow-400 mb-4">ğŸ¯ Available Rides</h2>
    <div id="ridesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
      <!-- Rides will be loaded here by JavaScript -->
    </div>

    <!-- No Rides Message -->
    <div id="noRidesMessage" class="hidden text-center py-12 bg-black/60 backdrop-blur-xl rounded-2xl border border-yellow-600/30">
      <div class="text-6xl mb-4">ğŸ˜”</div>
      <p class="text-2xl text-gray-400 mb-4">No rides available</p>
      <p class="text-gray-500 mb-6">Try adjusting your search filters or check back later</p>
      <a href="finalofferaride.html">
        <button class="px-6 py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-black font-bold rounded-lg hover:shadow-lg transition">
          ğŸ¯ Become a Driver
        </button>
      </a>
    </div>
  </div>

  <script>
    // ========================================
    // JAVASCRIPT - BOOK RIDE FUNCTIONALITY
    // ========================================

    // ===== JS PROGRAMMING BASICS - Variables =====
    const API_URL = 'http://localhost:3000';
    let currentUser = null;
    let allRides = []; // Array to store all rides

    // DOM elements
    const ridesContainer = document.getElementById('ridesContainer');
    const welcomeMsg = document.getElementById('welcomeMessage');
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    const filterVehicle = document.getElementById('filterVehicle');
    const filterDate = document.getElementById('filterDate');
    const searchLocation = document.getElementById('searchLocation');
    const searchBtn = document.getElementById('searchBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noRidesMessage = document.getElementById('noRidesMessage');
    const totalRidesEl = document.getElementById('totalRides');
    const totalSeatsEl = document.getElementById('totalSeats');
    const userDiscountEl = document.getElementById('userDiscount');

    // ===== CHECK IF USER IS LOGGED IN =====
    function checkLogin() {
      const userString = localStorage.getItem('currentUser');
      
      // Control Flow
      if (!userString) {
        alert('âš ï¸ Please login first to book rides!');
        window.location.href = 'finallogin.html';
        return false;
      }
      
      currentUser = JSON.parse(userString);
      return true;
    }

    // ===== DOM MANIPULATION - Display Welcome Message =====
    function displayWelcomeMessage() {
      if (currentUser.isStudent && currentUser.studentId) {
        welcomeMsg.innerHTML = Welcome back, <strong>${currentUser.name}</strong>! ğŸ“ <span class="text-green-400 font-semibold">Your 15% student discount is active!</span>;
        userDiscountEl.textContent = '15%';
      } else {
        welcomeMsg.innerHTML = Welcome back, <strong>${currentUser.name}</strong>! Ready to find your perfect ride?;
        userDiscountEl.textContent = '0%';
      }
      
      userInfo.textContent = ğŸ‘¤ ${currentUser.name};
    }

    // ===== LOGOUT FUNCTION =====
    logoutBtn.addEventListener('click', function() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('currentUser');
        window.location.href = 'finallogin.html';
      }
    });

    // ===== CALCULATE STUDENT DISCOUNT (Function) =====
    function calculatePrice(basePrice) {
      // Control Flow - check if student
      if (currentUser.isStudent && currentUser.studentId) {
        const discount = basePrice * 0.15;
        const finalPrice = basePrice - discount;
        return {
          original: basePrice,
          final: Math.round(finalPrice),
          discount: Math.round(discount),
          isDiscounted: true
        };
      }
      return {
        original: basePrice,
        final: basePrice,
        discount: 0,
        isDiscounted: false
      };
    }

    // ===== FETCH API - GET RIDES FROM JSON SERVER =====
    async function loadRides() {
      loadingIndicator.classList.remove('hidden');
      ridesContainer.innerHTML = '';
      noRidesMessage.classList.add('hidden');

      try {
        const response = await fetch(${API_URL}/rides);
        
        // Control Flow - check response
        if (!response.ok) {
          throw new Error('Failed to fetch rides');
        }

        allRides = await response.json(); // Store in array
        
        // Filter only active rides with available seats
        const availableRides = allRides.filter(ride => 
          ride.status === 'active' && ride.bookedSeats < ride.seats
        );
        
        displayRides(availableRides);
        updateStats(availableRides);

      } catch (error) {
        console.error('Error loading rides:', error);
        ridesContainer.innerHTML = `
          <div class="col-span-3 text-center p-8 bg-red-900/20 rounded-xl border border-red-500">
            <p class="text-red-400 text-xl mb-2">âŒ Error loading rides</p>
            <p class="text-gray-400 mb-4">Make sure JSON Server is running on port 3000</p>
            <button onclick="location.reload()" class="px-6 py-2 bg-yellow-600 text-black rounded-lg hover:bg-yellow-500 transition">
              ğŸ”„ Retry
            </button>
          </div>
        `;
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    // ===== UPDATE STATISTICS =====
    function updateStats(rides) {
      totalRidesEl.textContent = rides.length;
      
      // Calculate total available seats
      const totalSeats = rides.reduce((sum, ride) => {
        return sum + (ride.seats - ride.bookedSeats);
      }, 0);
      
      totalSeatsEl.textContent = totalSeats;
    }

    // ===== DOM MANIPULATION - Display Rides =====
    function displayRides(rides) {
      if (rides.length === 0) {
        noRidesMessage.classList.remove('hidden');
        updateStats(rides);
        return;
      }

      noRidesMessage.classList.add('hidden');

      // Array method - map to create HTML
      ridesContainer.innerHTML = rides.map(ride => {
        const availableSeats = ride.seats - ride.bookedSeats;
        const priceInfo = calculatePrice(ride.pricePerSeat);
        
        // Get vehicle emoji
        const vehicleEmoji = ride.vehicleType === 'Car' ? 'ğŸš—' : 
                            ride.vehicleType === 'Auto' ? 'ğŸ›º' : 'ğŸï¸';
        
        return `
          <div class="ride-card bg-gray-900/80 backdrop-blur-sm rounded-2xl p-6 border border-yellow-600/40 hover:border-yellow-500">
            <!-- Header -->
            <div class="flex justify-between items-start mb-4">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center text-2xl">
                  ${vehicleEmoji}
                </div>
                <div>
                  <h3 class="text-xl font-bold text-yellow-400">${ride.driverName}</h3>
                  <p class="text-gray-400 text-sm">${ride.vehicleType}</p>
                </div>
              </div>
              <span class="bg-green-500 text-black px-3 py-1 rounded-full text-sm font-bold pulse">
                ${availableSeats} seat${availableSeats > 1 ? 's' : ''}
              </span>
            </div>
            
            <!-- Route Info -->
            <div class="space-y-3 mb-4 bg-black/30 rounded-lg p-4">
              <div class="flex items-start text-gray-300">
                <span class="mr-2 text-green-400">ğŸ“</span>
                <div class="flex-1">
                  <p class="text-xs text-gray-500">FROM</p>
                  <p class="font-semibold">${ride.from}</p>
                </div>
              </div>
              <div class="border-l-2 border-yellow-500 ml-1 h-4"></div>
              <div class="flex items-start text-gray-300">
                <span class="mr-2 text-red-400">ğŸ“</span>
                <div class="flex-1">
                  <p class="text-xs text-gray-500">TO</p>
                  <p class="font-semibold">${ride.to}</p>
                </div>
              </div>
            </div>
<!-- Details -->
            <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
              <div class="flex items-center text-gray-300">
                <span class="mr-2">ğŸ“…</span>
                <span>${ride.date}</span>
              </div>
              <div class="flex items-center text-gray-300">
                <span class="mr-2">ğŸ•</span>
                <span>${ride.time}</span>
              </div>
              <div class="flex items-center text-gray-300">
                <span class="mr-2">ğŸ“</span>
                <span>${ride.driverPhone}</span>
              </div>
              <div class="flex items-center text-gray-300">
                <span class="mr-2">ğŸ’º</span>
                <span>${ride.bookedSeats}/${ride.seats} booked</span>
              </div>
            </div>
            
            ${ride.notes ? `
              <div class="mb-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                <p class="text-blue-300 text-sm">ğŸ“ ${ride.notes}</p>
              </div>
            ` : ''}
            
            <!-- Price -->
            <div class="mb-4 p-4 bg-gradient-to-r from-yellow-600/20 to-yellow-500/20 rounded-lg border border-yellow-500/50">
              <div class="flex items-center justify-between">
                <span class="text-gray-300">Price per seat:</span>
                <div class="text-right">
                  <span class="text-2xl font-bold text-yellow-400">â‚¹${priceInfo.final}</span>
                  ${priceInfo.isDiscounted ? `
                    <div class="text-xs">
                      <span class="line-through text-gray-500">â‚¹${priceInfo.original}</span>
                      <span class="text-green-400 font-semibold ml-2">Save â‚¹${priceInfo.discount}!</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
            
            <!-- Book Button -->
            <button 
              onclick="bookRide(${ride.id}, ${priceInfo.final}, '${ride.driverName}', '${ride.from}', '${ride.to}')" 
              class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black font-bold py-3 rounded-xl hover:shadow-lg transform hover:scale-105 transition"
              ${availableSeats === 0 ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>
              ${availableSeats === 0 ? 'ğŸš« Fully Booked' : 'ğŸ« Book This Ride'}
            </button>
          </div>
        `;
      }).join('');
    }

    // ===== BOOK RIDE FUNCTION WITH FETCH API (POST & PUT) =====
    async function bookRide(rideId, finalPrice, driverName, from, to) {
      // Confirmation dialog
      const confirmMessage = `
ğŸ« Confirm Booking

Driver: ${driverName}
Route: ${from} â†’ ${to}
Price: â‚¹${finalPrice}

Proceed with booking?
      `;
      
      if (!confirm(confirmMessage)) {
        return;
      }

      // Show loading
      const bookButtons = document.querySelectorAll('button');
      bookButtons.forEach(btn => btn.disabled = true);

      try {
        // 1. GET ride details
        const rideResponse = await fetch(${API_URL}/rides/${rideId});
        const ride = await rideResponse.json();

        // Control Flow - check seat availability
        if (ride.bookedSeats >= ride.seats) {
          alert('âŒ Sorry, this ride is fully booked!');
          bookButtons.forEach(btn => btn.disabled = false);
          return;
        }

        // 2. POST booking record (JSON Object)
        const bookingData = {
          userId: currentUser.id,
          userName: currentUser.name,
          userEmail: currentUser.email,
          userPhone: currentUser.phone,
          rideId: rideId,
          driverName: driverName,
          route: ${from} â†’ ${to},
          amount: finalPrice,
          bookingDate: new Date().toISOString(),
          rideDate: ride.date,
          rideTime: ride.time,
          status: 'confirmed'
        };

        const bookingResponse = await fetch(${API_URL}/bookings, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bookingData)
        });

        // Control Flow
        if (!bookingResponse.ok) {
          throw new Error('Booking failed');
        }

        const newBooking = await bookingResponse.json();

        // 3. PUT - Update ride to increase booked seats
        const updatedRide = {
          ...ride,
          bookedSeats: ride.bookedSeats + 1,
          passengers: [...(ride.passengers || []), currentUser.id]
        };

        await fetch(${API_URL}/rides/${rideId}, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedRide)
        });

        // Success message
        alert(`
ğŸ‰ Booking Successful!

Booking ID: #${newBooking.id}
Driver: ${driverName}
Route: ${from} â†’ ${to}
Amount: â‚¹${finalPrice}
Date: ${ride.date} at ${ride.time}

âœ… Confirmation sent to ${currentUser.email}
ğŸ“± Driver will contact you at ${currentUser.phone}

Have a safe journey!
        `);
        
        // Reload rides
        loadRides();

      } catch (error) {
        console.error('Booking error:', error);
        alert('âŒ Error booking ride. Please try again.');
        bookButtons.forEach(btn => btn.disabled = false);
      }
    }

    // Make bookRide function global
    window.bookRide = bookRide;

    // ===== SEARCH/FILTER FUNCTIONALITY (Arrays & Control Flow) =====
    searchBtn.addEventListener('click', function() {
      const vehicleType = filterVehicle.value;
      const date = filterDate.value;
      const location = searchLocation.value.toLowerCase().trim();

      // Array method - filter
      let filteredRides = allRides.filter(ride => {
        let matches = true;

        // Only show active rides with available seats
        if (ride.status !== 'active' || ride.bookedSeats >= ride.seats) {
          return false;
        }

        // Control Flow - multiple conditions
        if (vehicleType && ride.vehicleType !== vehicleType) {
          matches = false;
        }

        if (date && ride.date !== date) {
          matches = false;
        }

        if (location) {
          const fromMatch = ride.from.toLowerCase().includes(location);
          const toMatch = ride.to.toLowerCase().includes(location);
          if (!fromMatch && !toMatch) {
            matches = false;
          }
        }

        return matches;
      });

      displayRides(filteredRides);
      updateStats(filteredRides);
    });

    // Clear filters
    filterVehicle.addEventListener('change', () => searchBtn.click());
    filterDate.addEventListener('change', () => searchBtn.click());

    // Real-time search
    searchLocation.addEventListener('input', () => {
      if (searchLocation.value.length >= 3 || searchLocation.value.length === 0) {
        searchBtn.click();
      }
    });

    // ===== SET MINIMUM DATE TO TODAY =====
    const today = new Date().toISOString().split('T')[0];
    filterDate.min = today;

    // ===== INITIALIZE PAGE =====
    if (checkLogin()) {
      displayWelcomeMessage();
      loadRides();
    }

    console.log('ğŸ‰ Book Ride page loaded successfully!');
    console.log('âœ… Fetching rides from JSON Server...');
  </script>
</body>
</html>
